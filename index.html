<script>
    let history = JSON.parse(localStorage.getItem('pinSeekerHistory')) || [];
    let bag = JSON.parse(localStorage.getItem('pinSeekerBag')) || [];

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
        showPage('game-container'); // Start on game page
        // Load selected clubs
        bag.forEach(club => {
            const clubName = club.replace(/\s\(.*\)/, '');
            const button = document.querySelector(`.club-button[onclick*="'${clubName}'"]`);
            if (button) {
                button.classList.add('selected');
                const degMatch = club.match(/\((\d+)°\)/);
                if (degMatch) {
                    const degInput = document.getElementById(`${clubName.toLowerCase().replace(/ /g, '-')}-deg`);
                    if (degInput) degInput.value = degMatch[1];
                }
            }
        });
        updateNavButtons('game-container');
    });

    // Toggle bag section visibility
    document.getElementById('toggle-bag').addEventListener('click', function() {
        const bagSection = document.getElementById('bag-section');
        bagSection.classList.toggle('active');
    });

    function updateNavButtons(activePage) {
        document.querySelectorAll('.nav-bar button').forEach(button => {
            button.classList.remove('active');
            // Match button ID to pageId
            if (button.id === (activePage === 'game-container' ? 'nav-game' : 'nav-user')) {
                button.classList.add('active');
            }
        });
    }

    function toggleClub(button, club) {
        button.classList.toggle('selected');
        const degInput = document.getElementById(`${club.toLowerCase().replace(/ /g, '-')}-deg`);
        if (degInput) {
            degInput.value = degInput.value || (club === "Lob Wedge" ? "60" : club === "Sand Wedge" ? "56" : club === "Gap Wedge" ? "50" : club === "Pitching Wedge" ? "46" : club === "Hybrid" ? "20" : "");
        }
    }

    function showPage(pageId) {
        // Hide all containers
        document.querySelectorAll('.container').forEach(container => {
            container.classList.remove('active');
            container.style.display = 'none';
            container.style.opacity = '0';
            container.style.transform = 'translateY(20px)';
        });
        // Show the target container
        const targetContainer = document.getElementById(pageId);
        targetContainer.classList.add('active');
        targetContainer.style.display = 'block';
        setTimeout(() => {
            targetContainer.style.opacity = '1';
            targetContainer.style.transform = 'translateY(0)';
        }, 50);
        updateNavButtons(pageId);
        if (pageId === 'user-container') {
            drawHistoryGraph();
            drawClubDistanceGraph();
        }
    }

    function saveBag() {
        bag = [];
        document.querySelectorAll('.club-button.selected').forEach(button => {
            const club = button.textContent;
            const degInput = document.getElementById(`${club.toLowerCase().replace(/ /g, '-')}-deg`);
            const degree = degInput ? parseInt(degInput.value) || null : null;
            if (degree && degInput) {
                bag.push(`${club} (${degree}°)`);
            } else {
                bag.push(club);
            }
        });
        localStorage.setItem('pinSeekerBag', JSON.stringify(bag));
        alert('Bag saved successfully!');
        showPage('game-container');
    }

    document.getElementById('save-bag').addEventListener('click', saveBag);

    function generateShots() {
        try {
            const min = parseInt(document.getElementById('minRange').value);
            const max = parseInt(document.getElementById('maxRange').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            document.getElementById('overallScore').innerHTML = '';
            document.getElementById('insights').innerHTML = '';

            if (isNaN(min) || isNaN(max) || isNaN(quantity) || min < 0 || max > 300 || min >= max || quantity < 1 || quantity > 50) {
                resultsDiv.innerHTML = '<p style="color: #D32F2F;">Please enter valid numbers: min ≥ 0, max ≤ 300, min < max, 1 ≤ shots ≤ 50.</p>';
                return;
            }

            if (bag.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #D32F2F;">Please set up your bag in the Profile tab first.</p>';
                return;
            }

            for (let i = 0; i < quantity; i++) {
                const distance = Math.floor(Math.random() * (max - min + 1)) + min;
                const shotDiv = document.createElement('div');
                shotDiv.className = 'shot';
                const clubOptions = bag.map(club => {
                    const clubName = club.replace(/\s\(.*\)/, '');
                    const suggestion = suggestClub(distance, club);
                    return `<option value="${club}" ${suggestion ? 'selected' : ''}>${club}${suggestion ? ' (Recommended)' : ''}</option>`;
                }).join('');
                shotDiv.innerHTML = `
                    <p class="target-distance">Shot ${i + 1}: Hit to <strong>${distance}</strong> yards</p>
                    <label>Club Used:</label>
                    <select id="club${i}">${clubOptions}</select>
                    <label>Carry Distance (yards):</label>
                    <input type="number" id="carryDistance${i}" placeholder="Enter carry distance" min="0" max="400">
                    <label>Lateral Deviation (feet):</label>
                    <input type="number" id="lateralDeviation${i}" placeholder="Enter feet off target line" min="0" max="200">
                    <select id="lateralDirection${i}">
                        <option value="1">Right</option>
                        <option value="-1">Left</option>
                    </select>
                    <button onclick="calculateScore(${i}, ${distance})">Score Shot</button>
                    <p id="score${i}"></p>
                `;
                resultsDiv.appendChild(shotDiv);
            }
            const averageButton = document.createElement('button');
            averageButton.className = 'average-button';
            averageButton.innerHTML = 'Calculate Overall Average';
            averageButton.onclick = calculateOverallAverage;
            resultsDiv.appendChild(averageButton);
        } catch (error) {
            console.error('Error in generateShots:', error);
            document.getElementById('results').innerHTML = '<p style="color: #D32F2F;">An error occurred while generating shots. Please try again.</p>';
        }
    }

    function suggestClub(targetDistance, club) {
        const clubData = history.filter(entry => entry.club === club);
        if (clubData.length === 0) return false;
        const avgDistance = clubData.reduce((sum, entry) => sum + entry.carryDistance, 0) / clubData.length;
        return Math.abs(avgDistance - targetDistance) < 10;
    }

    function calculateScore(shotIndex, targetDistance) {
        const carryDistance = parseFloat(document.getElementById(`carryDistance${shotIndex}`).value);
        const lateralDeviation = parseFloat(document.getElementById(`lateralDeviation${shotIndex}`).value);
        const lateralDirection = parseInt(document.getElementById(`lateralDirection${shotIndex}`).value);
        const club = document.getElementById(`club${shotIndex}`).value;
        const scoreElement = document.getElementById(`score${shotIndex}`);

        if (isNaN(carryDistance) || isNaN(lateralDeviation) || carryDistance < 0 || lateralDeviation < 0) {
            scoreElement.innerHTML = '<span style="color: #D32F2F;">Please enter valid numbers for carry distance and lateral deviation (≥ 0).</span>';
            return;
        }

        const distanceError = Math.abs(targetDistance - carryDistance);
        const maxDistanceError = targetDistance * 0.2;
        const distanceScore = Math.max(0, 50 * (1 - distanceError / maxDistanceError));

        const maxLateralDeviation = 90;
        const effectiveLateralDeviation = lateralDeviation * lateralDirection;
        const lateralScore = Math.max(0, 50 * (1 - Math.abs(effectiveLateralDeviation) / maxLateralDeviation));

        const totalScore = Math.round(distanceScore + lateralScore);
        scoreElement.innerHTML = `Score: ${totalScore}/100`;
        history.push({ score: totalScore, carryDistance, club, lateralDeviation: effectiveLateralDeviation, timestamp: new Date().getTime(), targetDistance });
        localStorage.setItem('pinSeekerHistory', JSON.stringify(history));
        drawHistoryGraph();
        drawClubDistanceGraph();
    }

    function calculateOverallAverage() {
        const quantity = parseInt(document.getElementById('quantity').value);
        let totalScore = 0;
        let scoredShots = 0;
        const scores = [];

        for (let i = 0; i < quantity; i++) {
            const scoreElement = document.getElementById(`score${i}`);
            const scoreText = scoreElement.innerHTML;
            if (scoreText.startsWith('Score: ')) {
                const score = parseInt(scoreText.replace('Score: ', '').replace('/100', ''));
                if (!isNaN(score)) {
                    totalScore += score;
                    scoredShots++;
                    scores.push({
                        index: i,
                        score: score,
                        carryDistance: parseFloat(document.getElementById(`carryDistance${i}`).value),
                        lateralDeviation: parseFloat(document.getElementById(`lateralDeviation${i}`).value) * parseInt(document.getElementById(`lateralDirection${i}`).value),
                        club: document.getElementById(`club${i}`).value
                    });
                }
            }
        }

        const overallScoreElement = document.getElementById('overallScore');
        if (scoredShots === 0) {
            overallScoreElement.innerHTML = '<span style="color: #D32F2F;">No scores entered yet. Score at least one shot first.</span>';
            document.getElementById('insights').innerHTML = '';
        } else {
            const averageScore = Math.round(totalScore / scoredShots);
            overallScoreElement.innerHTML = `Overall Average Score: ${averageScore}/100`;
            generateInsights(scores, averageScore);
        }
    }

    function generateInsights(scores, overallAverage) {
        const insightsDiv = document.getElementById('insights');
        let insights = '<h3>Session Insights</h3><ul>';

        if (scores.length === 0) {
            insights += '<li>No shots scored yet.</li>';
        } else {
            // General session summary
            const avgLateral = scores.reduce((sum, s) => sum + Math.abs(s.lateralDeviation), 0) / scores.length;
            insights += `<li>Session average score: ${overallAverage}/100, with ${avgLateral.toFixed(1)} feet average lateral deviation.</li>`;

            // Identify key area for improvement
            let keyIssue = '';
            const rightMisses = scores.filter(s => s.lateralDeviation > 0).length;
            if (rightMisses / scores.length > 0.6) {
                keyIssue = 'You frequently miss right. Focus on adjusting your aim slightly left to compensate.';
            } else if (rightMisses / scores.length < 0.4) {
                keyIssue = 'You frequently miss left. Practice aligning your stance slightly right of the target.';
            } else {
                const clubVariances = {};
                history.forEach(entry => {
                    if (!clubVariances[entry.club]) clubVariances[entry.club] = [];
                    clubVariances[entry.club].push(entry.carryDistance);
                });
                let maxVarianceClub = '';
                let maxVariance = 0;
                for (const club in clubVariances) {
                    const distances = clubVariances[club];
                    if (distances.length > 1) {
                        const avg = distances.reduce((sum, d) => sum + d, 0) / distances.length;
                        const variance = distances.reduce((sum, d) => sum + Math.pow(d - avg, 2), 0) / distances.length;
                        if (variance > maxVariance) {
                            maxVariance = variance;
                            maxVarianceClub = club;
                        }
                    }
                }
                if (maxVariance > 100) {
                    keyIssue = `Inconsistent distances with ${maxVarianceClub}. Practice this club to improve consistency.`;
                } else {
                    keyIssue = overallAverage > 60 ? 'Solid session. Refine your distance control with shorter clubs.' : 'Focus on hitting closer to target distances to boost your score.';
                }
            }
            insights += `<li><strong>Key Action:</strong> ${keyIssue}</li>`;
        }

        insights += '</ul>';
        insightsDiv.innerHTML = insights;
    }

    function drawHistoryGraph() {
        const container = document.getElementById('history-graph');
        container.innerHTML = '<canvas id="history-canvas"></canvas>';
        const canvas = document.getElementById('history-canvas');
        const ctx = canvas.getElementById('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const sessions = {};
        history.forEach(entry => {
            const date = new Date(entry.timestamp).toLocaleDateString();
            if (!sessions[date]) sessions[date] = [];
            sessions[date].push(entry.score);
        });

        const dates = Object.keys(sessions).sort();
        const scores = dates.map(date => {
            const sessionScores = sessions[date];
            return sessionScores.length > 0 ? Math.round(sessionScores.reduce((sum, score) => sum + score, 0) / sessionScores.length) : 0;
        });

        new Chart(canvas, {
            type: 'line',
            data: {
                labels: dates.map(d => d.split('/')[1] + '/' + d.split('/')[2]),
                datasets: [{
                    label: 'Average Score',
                    data: scores,
                    borderColor: '#2E7D32',
                    backgroundColor: 'rgba(46, 125, 50, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { min: 0, max: 100, title: { display: true, text: 'Score' } },
                    x: { title: { display: true, text: 'Date' } }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { enabled: true }
                }
            }
        });
    }

    function drawClubDistanceGraph() {
        const container = document.getElementById('club-distance-graph');
        container.innerHTML = '<canvas id="club-distance-canvas"></canvas>';
        const canvas = document.getElementById('club-distance-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (bag.length === 0) return;

        const clubAverages = {};
        bag.forEach(club => {
            const clubData = history.filter(entry => entry.club === club);
            clubAverages[club] = clubData.length > 0 ? Math.round(clubData.reduce((sum, entry) => sum + entry.carryDistance, 0) / clubData.length) : 0;
        });

        new Chart(canvas, {
            type: 'bar',
            data: {
                labels: bag.map(club => club.replace(/\s\(.*\)/, '').slice(0, 3)),
                datasets: [{
                    label: 'Average Distance (yards)',
                    data: bag.map(club => clubAverages[club]),
                    backgroundColor: 'rgba(46, 125, 50, 0.8)',
                    borderColor: '#D4A017',
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Distance (yards)' } },
                    y: { title: { display: true, text: 'Clubs' } }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { enabled: true }
                }
            }
        });
    }

    function exportData() {
        const data = JSON.stringify({ history, bag });
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pin_seeker_data.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData() {
        document.getElementById('import-file').click();
    }

    document.getElementById('import-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.history && data.bag) {
                    history = data.history;
                    bag = data.bag;
                    localStorage.setItem('pinSeekerHistory', JSON.stringify(history));
                    localStorage.setItem('pinSeekerBag', JSON.stringify(bag));
                    alert('Data imported successfully!');
                    showPage('user-container');
                } else {
                    alert('Invalid file format.');
                }
            } catch (err) {
                alert('Error importing data.');
            }
        };
        reader.readAsText(file);
    });

    function resetAll() {
        document.getElementById('minRange').value = '50';
        document.getElementById('maxRange').value = '200';
        document.getElementById('quantity').value = '5';
        document.getElementById('results').innerHTML = '';
        document.getElementById('overallScore').innerHTML = '';
        document.getElementById('insights').innerHTML = '';
    }
</script>
